<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>system-coroner â€” {{.Hostname}}</title>
<style>
:root {
  --bg:#0d1117;--fg:#c9d1d9;--card:#161b22;--border:#30363d;
  --red:#dc2626;--yellow:#d97706;--green:#3fb950;--blue:#58a6ff;
  --red-bg:#3d1418;--yellow-bg:#3d2200;--green-bg:#0d3117;
  --fg-muted:#8b949e;--card2:#1c2128;--topbar-h:48px;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Helvetica,Arial,sans-serif;background:var(--bg);color:var(--fg);line-height:1.6;padding-top:var(--topbar-h);}

/* â”€â”€ Topbar â”€â”€ */
.topbar{position:fixed;top:0;left:0;right:0;height:var(--topbar-h);background:rgba(13,17,23,.96);border-bottom:1px solid var(--border);backdrop-filter:blur(8px);z-index:200;display:flex;align-items:center;padding:0 20px;}
.topbar-inner{display:flex;align-items:center;justify-content:space-between;width:100%;max-width:1440px;margin:0 auto;}
.topbar-logo{font-size:.85em;font-weight:700;color:var(--fg-muted);letter-spacing:.05em;}
.topbar-actions{display:flex;gap:6px;align-items:center;}

/* â”€â”€ Layout â”€â”€ */
.page-layout{display:flex;max-width:1440px;margin:0 auto;padding:20px;gap:20px;align-items:flex-start;}
.main-content{flex:1;min-width:0;}

/* â”€â”€ TOC â”€â”€ */
.toc{width:196px;flex-shrink:0;position:sticky;top:calc(var(--topbar-h) + 14px);max-height:calc(100vh - var(--topbar-h) - 28px);overflow-y:auto;background:var(--card);border:1px solid var(--border);border-radius:8px;padding:10px 0;}
.toc::-webkit-scrollbar{width:4px;}
.toc::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
.toc-title{font-size:.7em;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--fg-muted);padding:0 12px 8px;border-bottom:1px solid var(--border);margin-bottom:4px;}
.toc-link{display:block;padding:4px 12px 4px 10px;font-size:.8em;color:var(--fg-muted);text-decoration:none;border-left:2px solid transparent;transition:color .15s,border-color .15s,background .15s;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:pointer;}
.toc-link:hover{color:var(--fg);background:rgba(255,255,255,.04);}
.toc-link.active{color:var(--blue);border-left-color:var(--blue);background:rgba(88,166,255,.08);font-weight:600;}
.toc-link.sub{padding-left:22px;font-size:.76em;}
.toc-sep{height:1px;background:var(--border);margin:6px 0;}

/* â”€â”€ Banner â”€â”€ */
.banner{padding:30px 24px;border-radius:8px;margin-bottom:14px;text-align:center;}
.banner-critical{background:#450a0a;border:3px solid var(--red);animation:pulse-border 2s ease-in-out infinite;}
.banner-critical h1{color:var(--red);}
.banner-red{background:var(--red-bg);border:2px solid var(--red);}
.banner-red h1{color:var(--red);}
.banner-yellow{background:var(--yellow-bg);border:2px solid var(--yellow);}
.banner-yellow h1{color:var(--yellow);}
.banner-green{background:var(--green-bg);border:2px solid var(--green);}
.banner-green h1{color:var(--green);}
.banner h1{font-size:1.9em;margin-bottom:6px;font-weight:800;letter-spacing:.04em;}
.banner p{font-size:1.02em;opacity:.9;}
@keyframes pulse-border{0%,100%{box-shadow:0 0 0 0 rgba(220,38,38,.5);}50%{box-shadow:0 0 0 10px rgba(220,38,38,0);}}

/* â”€â”€ Summary stats â”€â”€ */
.summary{display:grid;grid-template-columns:repeat(auto-fit,minmax(110px,1fr));gap:10px;margin-bottom:14px;}
.stat-card{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:12px 10px;text-align:center;}
.stat-card .value{font-size:1.7em;font-weight:700;}
.stat-card .label{font-size:.75em;opacity:.55;margin-top:2px;}

/* â”€â”€ Section â”€â”€ */
.report-section{margin-bottom:12px;scroll-margin-top:calc(var(--topbar-h) + 10px);}
.sec-hdr{display:flex;align-items:center;justify-content:space-between;background:var(--card);border:1px solid var(--border);border-radius:8px;padding:12px 16px;cursor:pointer;user-select:none;transition:background .15s;}
.sec-hdr:hover{background:var(--card2);}
.sec-hdr.is-open{border-radius:8px 8px 0 0;border-bottom-color:transparent;}
.sec-hdr h2{font-size:1.05em;color:var(--blue);font-weight:600;}
.hdr-right{display:flex;align-items:center;gap:6px;flex-shrink:0;}
.chevron{font-size:.9em;color:var(--fg-muted);transition:transform .2s;display:inline-block;margin-left:4px;}
.chevron.closed{transform:rotate(-90deg);}
.sec-body{background:var(--card);border:1px solid var(--border);border-top:none;border-radius:0 0 8px 8px;padding:16px;overflow:hidden;}
.sec-body.hidden{display:none;}

/* â”€â”€ Finding cards â”€â”€ */
.finding-card{border:1px solid var(--border);border-radius:8px;margin-bottom:10px;overflow:hidden;scroll-margin-top:calc(var(--topbar-h) + 10px);}
.finding-card:last-child{margin-bottom:0;}
.finding-card.sev-confirmed{border-left:3px solid #dc2626;}
.finding-card.sev-likely   {border-left:3px solid #d97706;}
.finding-card.sev-suspected{border-left:3px solid #ca8a04;}
.finding-card.sev-informational{border-left:3px solid var(--border);}
.finding-hdr{display:flex;align-items:center;gap:8px;padding:11px 14px;cursor:pointer;user-select:none;background:rgba(255,255,255,.025);transition:background .15s;flex-wrap:wrap;}
.finding-hdr:hover{background:rgba(255,255,255,.05);}
.finding-title{flex:1;font-weight:600;font-size:.92em;min-width:120px;}
.finding-body{padding:14px;border-top:1px solid var(--border);}
.finding-body.hidden{display:none;}

/* â”€â”€ Badges â”€â”€ */
.badge{display:inline-block;padding:2px 7px;border-radius:10px;font-size:.72em;font-weight:700;text-transform:uppercase;letter-spacing:.03em;}
.confidence-confirmed{background:#dc2626;color:#fff;}
.confidence-high{background:#d97706;color:#fff;}
.confidence-medium{background:#ca8a04;color:#fff;}
.confidence-low{background:#388bfd;color:#fff;}
.confidence-info{background:var(--border);color:var(--fg);}
.risk-critical{background:#dc2626;color:#fff;}
.risk-high{background:#d97706;color:#fff;}
.risk-medium{background:#ca8a04;color:#fff;}
.risk-low{background:var(--border);color:var(--fg);}

/* â”€â”€ Content elements â”€â”€ */
.field-lbl{font-size:.77em;font-weight:700;letter-spacing:.05em;text-transform:uppercase;color:var(--fg-muted);margin:12px 0 4px;}
.field-lbl:first-child{margin-top:0;}
.evidence-list{list-style:none;padding:0;}
.evidence-list li{padding:5px 0;border-bottom:1px solid var(--border);font-family:monospace;font-size:.86em;}
.evidence-list li:last-child{border-bottom:none;}
.mitre-tag{display:inline-block;background:#1f2937;border:1px solid var(--blue);color:var(--blue);padding:2px 6px;border-radius:4px;font-size:.78em;margin:2px;}
.action-list{list-style:decimal;padding-left:20px;}
.action-list li{padding:3px 0;font-size:.9em;}

/* â”€â”€ Reasoning â”€â”€ */
.reasoning{background:rgba(255,255,255,.03);border-radius:4px;padding:12px;font-size:.88em;}
.reasoning dt{font-weight:700;color:var(--blue);margin-top:8px;font-size:.82em;text-transform:uppercase;letter-spacing:.04em;}
.reasoning dt:first-child{margin-top:0;}
.reasoning dd{margin-left:12px;margin-top:2px;}

/* â”€â”€ Timeline â”€â”€ */
.timeline{position:relative;padding-left:20px;}
.timeline::before{content:'';position:absolute;left:6px;top:4px;bottom:4px;width:2px;background:var(--border);}
.tl-item{position:relative;padding:6px 0 6px 14px;}
.tl-item::before{content:'';position:absolute;left:-15px;top:13px;width:8px;height:8px;border-radius:50%;background:var(--blue);border:2px solid var(--bg);}
.tl-time{font-family:monospace;font-size:.8em;color:var(--blue);}
.tl-event{margin-top:2px;font-size:.9em;}

/* â”€â”€ Tables â”€â”€ */
table{width:100%;border-collapse:collapse;font-size:.88em;}
th,td{padding:7px 12px;text-align:left;border-bottom:1px solid var(--border);}
th{background:rgba(255,255,255,.04);font-weight:600;font-size:.78em;text-transform:uppercase;letter-spacing:.04em;color:var(--fg-muted);}
td{font-family:monospace;font-size:.84em;}
tr:last-child td{border-bottom:none;}

/* â”€â”€ Details / inner collapsibles â”€â”€ */
details{margin-top:10px;}
details summary{cursor:pointer;color:var(--blue);font-size:.87em;padding:3px 0;list-style:none;display:flex;align-items:center;gap:4px;}
details summary::-webkit-details-marker{display:none;}
details summary::before{content:'â–¸';font-size:.85em;flex-shrink:0;}
details[open] summary::before{content:'â–¾';}
details summary:hover{text-decoration:underline;}

/* â”€â”€ Kill chain â”€â”€ */
.kc-initial  {background:#1d4ed8;color:#fff;padding:2px 6px;border-radius:4px;font-size:.74em;white-space:nowrap;}
.kc-execution{background:#b45309;color:#fff;padding:2px 6px;border-radius:4px;font-size:.74em;white-space:nowrap;}
.kc-evasion  {background:#065f46;color:#fff;padding:2px 6px;border-radius:4px;font-size:.74em;white-space:nowrap;}
.kc-lateral  {background:#7c3aed;color:#fff;padding:2px 6px;border-radius:4px;font-size:.74em;white-space:nowrap;}
.kc-impact   {background:#dc2626;color:#fff;padding:2px 6px;border-radius:4px;font-size:.74em;white-space:nowrap;}
.kc-default  {background:var(--border);color:var(--fg);padding:2px 6px;border-radius:4px;font-size:.74em;white-space:nowrap;}

/* â”€â”€ Failure kind â”€â”€ */
.fk-timeout   {background:#b45309;color:#fff;}
.fk-permission{background:#dc2626;color:#fff;}
.fk-script    {background:#ca8a04;color:#fff;}
.fk-notfound  {background:#6b7280;color:#fff;}
.fk-unknown   {background:var(--border);color:var(--fg);}

/* â”€â”€ Sigma â”€â”€ */
.sigma-critical{background:#7f1d1d;color:#fca5a5;border:1px solid #dc2626;}
.sigma-high    {background:#7c2d12;color:#fdba74;border:1px solid #ea580c;}
.sigma-medium  {background:#713f12;color:#fde68a;border:1px solid #d97706;}
.sigma-low     {background:#1e3a5f;color:#93c5fd;border:1px solid #3b82f6;}
.sigma-info    {background:var(--card);color:var(--fg-muted);border:1px solid var(--border);}
.sigma-card{border:1px solid var(--border);border-radius:6px;padding:11px 13px;margin-bottom:8px;}
.sigma-card:last-child{margin-bottom:0;}
.sigma-hdr{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:4px;}
.sigma-event{font-family:monospace;font-size:.78em;color:var(--fg-muted);margin-top:8px;white-space:pre-wrap;word-break:break-all;}

/* â”€â”€ JSON viewer â”€â”€ */
.json-viewer{background:rgba(0,0,0,.3);border-radius:4px;padding:12px;font-family:monospace;font-size:.8em;overflow-x:auto;white-space:pre;max-height:360px;overflow-y:auto;margin-top:8px;}
.json-key{color:#60a5fa;}.json-str{color:#34d399;}.json-num{color:#fb923c;}.json-bool{color:#a78bfa;}.json-null{color:#9ca3af;}

/* â”€â”€ Buttons â”€â”€ */
.btn{display:inline-flex;align-items:center;gap:3px;padding:3px 9px;border-radius:5px;font-size:.76em;cursor:pointer;border:1px solid var(--border);background:transparent;color:var(--fg-muted);transition:all .15s;white-space:nowrap;}
.btn:hover{border-color:var(--blue);color:var(--blue);background:rgba(88,166,255,.1);}
.btn.ok{border-color:var(--green);color:var(--green);}
.btn-solid{background:var(--card2);color:var(--fg);}

/* â”€â”€ Footer â”€â”€ */
.footer{text-align:center;padding:28px 16px;opacity:.4;font-size:.8em;}

/* â”€â”€ Light theme â”€â”€ */
[data-theme="light"]{--bg:#fff;--fg:#1f2328;--card:#f6f8fa;--border:#d0d7de;--blue:#0969da;--fg-muted:#636c76;--red-bg:#fff0ee;--yellow-bg:#fff8e5;--green-bg:#f0fff4;--card2:#eaeef2;}
[data-theme="light"] .topbar{background:rgba(255,255,255,.96);}
[data-theme="light"] .reasoning{background:rgba(0,0,0,.03);}
[data-theme="light"] .json-viewer{background:rgba(0,0,0,.04);}
[data-theme="light"] .tl-item::before{border-color:var(--bg);}

/* â”€â”€ Responsive â”€â”€ */
@media(max-width:880px){.toc{display:none;}.page-layout{padding:12px;}}
</style>
</head>
<body>

<!-- Topbar -->
<header class="topbar">
  <div class="topbar-inner">
    <span class="topbar-logo">system-coroner / {{.Hostname}}</span>
    <div class="topbar-actions">
      <button class="btn btn-solid" id="btn-copy-all" onclick="copyAllReport()">Copy Report</button>
      <button class="btn btn-solid theme-toggle" id="theme-btn" onclick="toggleTheme()">â˜€ Light</button>
    </div>
  </div>
</header>

<div class="page-layout">
<main class="main-content">

<!-- Banner -->
<div id="s-banner" class="banner {{bannerClass .Isolation}}" style="scroll-margin-top:calc(var(--topbar-h) + 10px)">
  {{if .Isolation.Isolate}}
  <h1>{{if eq .Isolation.Urgency "immediate"}}ISOLATE IMMEDIATELY{{else}}ISOLATION RECOMMENDED{{end}}</h1>
  {{else if eq .Isolation.Banner "yellow"}}
  <h1>INVESTIGATION NEEDED</h1>
  {{else}}
  <h1>NO INTRUSION DETECTED</h1>
  {{end}}
  <p>{{.Isolation.Reason}}</p>
</div>

{{if .AnalystContext}}
<div style="background:var(--card);border:1px solid var(--blue);border-radius:8px;padding:12px 16px;margin-bottom:14px;display:flex;align-items:center;gap:10px;">
  <span style="font-size:1.2em;">&#x1F4AC;</span>
  <div>
    <strong style="font-size:.85em;color:var(--blue);">Analyst Context Applied</strong>
    <p style="font-size:.88em;opacity:.85;margin-top:2px;">{{.AnalystContext}}</p>
  </div>
</div>
{{end}}

<!-- Summary Stats -->
<div id="s-summary" class="summary" style="scroll-margin-top:calc(var(--topbar-h) + 10px)">
  <div class="stat-card">
    <div class="value">{{.TotalChecks}}</div>
    <div class="label">Checks</div>
  </div>
  <div class="stat-card">
    <div class="value" style="color:#dc2626">{{.ConfidenceSummary.Confirmed}}</div>
    <div class="label">Confirmed</div>
  </div>
  <div class="stat-card">
    <div class="value" style="color:#d97706">{{.ConfidenceSummary.High}}</div>
    <div class="label">Likely</div>
  </div>
  <div class="stat-card">
    <div class="value" style="color:#ca8a04">{{.ConfidenceSummary.Medium}}</div>
    <div class="label">Suspected</div>
  </div>
  <div class="stat-card">
    <div class="value" style="color:var(--blue)">{{.ConfidenceSummary.Low}}</div>
    <div class="label">Low</div>
  </div>
  <div class="stat-card">
    <div class="value" style="color:var(--green)">{{.ConfidenceSummary.Clean}}</div>
    <div class="label">Clean</div>
  </div>
</div>

<!-- Verdict -->
{{if .Verdict}}
<section class="report-section" id="s-verdict">
  <div class="sec-hdr is-open" onclick="toggleSec('verdict')">
    <h2>Overall Verdict</h2>
    <div class="hdr-right">
      <button class="btn" onclick="event.stopPropagation();copySection('verdict',this)">Copy</button>
      <span class="chevron" id="chev-verdict">â–¾</span>
    </div>
  </div>
  <div class="sec-body" id="body-verdict">
    <p><strong>Status:</strong> {{.Verdict.OverallVerdict.Status}}</p>
    <p style="margin-top:5px"><strong>Confidence:</strong> {{.Verdict.OverallVerdict.Confidence}}</p>
    <p style="margin-top:5px"><strong>Recommendation:</strong> {{.Verdict.OverallVerdict.Recommendation}}</p>
    <p style="margin-top:8px;opacity:.9">{{.Verdict.OverallVerdict.Summary}}</p>
  </div>
</section>
{{end}}

<!-- Timeline -->
{{if .Verdict}}{{if .Verdict.Timeline}}
<section class="report-section" id="s-timeline">
  <div class="sec-hdr is-open" onclick="toggleSec('timeline')">
    <h2>Attack Timeline</h2>
    <div class="hdr-right">
      <button class="btn" onclick="event.stopPropagation();copySection('timeline',this)">Copy</button>
      <span class="chevron" id="chev-timeline">â–¾</span>
    </div>
  </div>
  <div class="sec-body" id="body-timeline">
    <div class="timeline">
      {{range .Verdict.Timeline}}
      <div class="tl-item">
        <div class="tl-time">{{.Timestamp}}</div>
        <div class="tl-event">
          {{.Event}}
          <span class="{{killChainClass .KillChainPhase}}" style="margin-left:6px">{{.KillChainPhase}}</span>
        </div>
      </div>
      {{end}}
    </div>
  </div>
</section>
{{end}}{{end}}

<!-- Findings -->
{{if .Findings}}
<section class="report-section" id="s-findings">
  <div class="sec-hdr is-open" onclick="toggleSec('findings')">
    <h2>Findings <span style="font-size:.8em;font-weight:400;color:var(--fg-muted)">({{len .Findings}})</span></h2>
    <div class="hdr-right">
      <button class="btn" onclick="event.stopPropagation();copySection('findings',this)">Copy</button>
      <span class="chevron" id="chev-findings">â–¾</span>
    </div>
  </div>
  <div class="sec-body" id="body-findings">
    {{range .Findings}}
    <div class="finding-card sev-{{.IntrusionConfidence}}" id="f-{{.Check}}">
      <div class="finding-hdr" onclick="toggleFinding('{{.Check}}')">
        <span class="badge {{confidenceClass .IntrusionConfidence}}">{{.IntrusionConfidence}}</span>
        <span class="badge {{riskClass .RiskLevel}}">{{.RiskLevel}}</span>
        <span class="finding-title">{{.Title}}</span>
        <span class="chevron" id="chev-f-{{.Check}}">â–¾</span>
      </div>
      <div class="finding-body" id="fbody-{{.Check}}">
        <div class="field-lbl">Check</div>
        <p style="font-family:monospace;font-size:.86em">{{.Check}}</p>

        <div class="field-lbl">Attack Scenario</div>
        <p style="font-size:.91em">{{.AttackScenario}}</p>

        {{if .MITRE}}
        <div class="field-lbl">MITRE ATT&CK</div>
        <p>{{range .MITRE}}<span class="mitre-tag">{{.}}</span>{{end}}</p>
        {{end}}

        {{if .Evidence}}
        <div class="field-lbl">Evidence</div>
        <ul class="evidence-list">
          {{range .Evidence}}<li>{{.}}</li>{{end}}
        </ul>
        {{end}}

        {{if .ImmediateActions}}
        <div class="field-lbl">Immediate Actions</div>
        <ol class="action-list">
          {{range .ImmediateActions}}<li>{{.}}</li>{{end}}
        </ol>
        {{end}}

        {{if .ForensicNextSteps}}
        <details>
          <summary>Forensic Next Steps</summary>
          <ol class="action-list" style="margin-top:8px">
            {{range .ForensicNextSteps}}<li>{{.}}</li>{{end}}
          </ol>
        </details>
        {{end}}

        <details>
          <summary>Reasoning Chain</summary>
          <dl class="reasoning" style="margin-top:8px">
            <dt>Observation</dt><dd>{{.ReasoningChain.Observation}}</dd>
            <dt>Baseline</dt><dd>{{.ReasoningChain.Baseline}}</dd>
            <dt>Deviation</dt><dd>{{.ReasoningChain.Deviation}}</dd>
            <dt>Context</dt><dd>{{.ReasoningChain.Context}}</dd>
            <dt>Conclusion</dt><dd>{{.ReasoningChain.Conclusion}}</dd>
          </dl>
        </details>

        {{$rawJSON := index $.RawCheckData .Check}}
        {{if $rawJSON}}
        <details>
          <summary>Raw Evidence <button class="btn" onclick="event.stopPropagation();copyJsonViewer('rv-{{.Check}}',this)" style="margin-left:6px">Copy</button></summary>
          <pre class="json-viewer" id="rv-{{.Check}}">{{$rawJSON}}</pre>
        </details>
        {{end}}
      </div>
    </div>
    {{end}}
  </div>
</section>
{{end}}

<!-- Analysis Failures -->
{{if .RawFindings}}
<section class="report-section" id="s-raw">
  <div class="sec-hdr" onclick="toggleSec('raw')">
    <h2>Analysis Failures</h2>
    <div class="hdr-right">
      <span class="chevron closed" id="chev-raw">â–¾</span>
    </div>
  </div>
  <div class="sec-body hidden" id="body-raw">
    <p style="margin-bottom:12px;opacity:.75;font-size:.9em">The following checks could not be parsed. Raw output is preserved for manual review.</p>
    {{range .RawFindings}}
    <details>
      <summary>{{.CheckID}} â€” {{.ParseError}}</summary>
      <pre style="overflow-x:auto;padding:12px;background:rgba(0,0,0,.3);border-radius:4px;font-size:.82em;margin-top:8px;white-space:pre-wrap">{{.RawOutput}}</pre>
    </details>
    {{end}}
  </div>
</section>
{{end}}

<!-- Sigma Matches -->
{{if .SigmaMatches}}
<section class="report-section" id="s-sigma">
  <div class="sec-hdr is-open" onclick="toggleSec('sigma')">
    <h2>Sigma Rule Matches <span class="badge sigma-high" style="font-size:.68em;vertical-align:middle;margin-left:6px">{{len .SigmaMatches}} hit{{if gt (len .SigmaMatches) 1}}s{{end}}</span></h2>
    <div class="hdr-right">
      <button class="btn" onclick="event.stopPropagation();copySection('sigma',this)">Copy</button>
      <span class="chevron" id="chev-sigma">â–¾</span>
    </div>
  </div>
  <div class="sec-body" id="body-sigma">
    <p style="margin-bottom:12px;opacity:.7;font-size:.88em">Deterministic Sigma rule detections â€” independent of LLM analysis.</p>
    {{range .SigmaMatches}}
    <div class="sigma-card">
      <div class="sigma-hdr">
        <span class="badge {{sigmaLevelClass .Level}}">{{.Level}}</span>
        <strong>{{.RuleTitle}}</strong>
        <span style="font-family:monospace;font-size:.78em;color:var(--fg-muted)">check: {{.CheckID}}</span>
        {{if .RuleID}}<span style="font-family:monospace;font-size:.74em;color:var(--fg-muted)">id: {{.RuleID}}</span>{{end}}
      </div>
      {{if .Event}}
      <details>
        <summary>Matched Event</summary>
        <pre class="sigma-event">{{range $k,$v := .Event}}{{$k}}: {{$v}}
{{end}}</pre>
      </details>
      {{end}}
    </div>
    {{end}}
  </div>
</section>
{{end}}

<!-- IoCs -->
{{if .IoCs}}
<section class="report-section" id="s-iocs">
  <div class="sec-hdr is-open" onclick="toggleSec('iocs')">
    <h2>Indicators of Compromise</h2>
    <div class="hdr-right">
      <button class="btn" onclick="event.stopPropagation();downloadIoCs('csv')">Export CSV</button>
      <button class="btn" onclick="event.stopPropagation();downloadIoCs('json')">Export JSON</button>
      <button class="btn" onclick="event.stopPropagation();copySection('iocs',this)">Copy</button>
      <span class="chevron" id="chev-iocs">â–¾</span>
    </div>
  </div>
  <div class="sec-body" id="body-iocs">
    <table id="ioc-table">
      <thead><tr><th>Type</th><th>Value</th><th>Source</th></tr></thead>
      <tbody>
        {{range .IoCs}}
        <tr><td>{{.Type}}</td><td>{{.Value}}</td><td>{{.Context}}</td></tr>
        {{end}}
      </tbody>
    </table>
  </div>
</section>
{{end}}

<!-- Data Gaps -->
{{if .Verdict}}{{if .Verdict.DataGaps}}
<section class="report-section" id="s-gaps">
  <div class="sec-hdr" onclick="toggleSec('gaps')">
    <h2>Data Gaps</h2>
    <div class="hdr-right">
      <span class="chevron closed" id="chev-gaps">â–¾</span>
    </div>
  </div>
  <div class="sec-body hidden" id="body-gaps">
    <ul style="padding-left:18px">
      {{range .Verdict.DataGaps}}<li style="padding:3px 0;font-size:.9em">{{.}}</li>{{end}}
    </ul>
  </div>
</section>
{{end}}{{end}}

<!-- Collection Failures -->
{{if .CollectionFailures}}
<section class="report-section" id="s-failures">
  <div class="sec-hdr" onclick="toggleSec('failures')">
    <h2>Collection Failures</h2>
    <div class="hdr-right">
      <span class="chevron closed" id="chev-failures">â–¾</span>
    </div>
  </div>
  <div class="sec-body hidden" id="body-failures">
    <p style="margin-bottom:12px;opacity:.7;font-size:.88em">The following checks failed to collect data. Analysis accuracy may be reduced for these areas.</p>
    <table>
      <thead><tr><th>Check</th><th>ID</th><th>Kind</th><th>Error</th></tr></thead>
      <tbody>
        {{range .CollectionFailures}}
        <tr>
          <td style="font-family:sans-serif">{{if .CheckName}}{{.CheckName}}{{else}}{{.CheckID}}{{end}}</td>
          <td>{{.CheckID}}</td>
          <td><span class="badge {{failureKindClass .FailureKind}}">{{.FailureKind}}</span></td>
          <td style="color:var(--red);word-break:break-word;max-width:300px">{{.Error}}</td>
        </tr>
        {{end}}
      </tbody>
    </table>
  </div>
</section>
{{end}}

<!-- Evidence Integrity -->
{{if .EvidenceHashes}}
<section class="report-section" id="s-integrity">
  <div class="sec-hdr" onclick="toggleSec('integrity')">
    <h2>Evidence Integrity (SHA-256)</h2>
    <div class="hdr-right">
      <span class="chevron closed" id="chev-integrity">â–¾</span>
    </div>
  </div>
  <div class="sec-body hidden" id="body-integrity">
    <table>
      <thead><tr><th>File</th><th>SHA-256</th><th>Size</th></tr></thead>
      <tbody>
        {{range .EvidenceHashes}}
        <tr>
          <td>{{.File}}</td>
          <td style="font-size:.76em;word-break:break-all">{{.SHA256}}</td>
          <td>{{.Size}} B</td>
        </tr>
        {{end}}
      </tbody>
    </table>
  </div>
</section>
{{end}}

<!-- Footer -->
<div class="footer">
  <p>system-coroner {{.Version}} Â· {{.GeneratedAt.Format "2006-01-02 15:04:05 UTC"}} Â· {{.OS}}</p>
  <p style="margin-top:3px">Collection: {{.CollectionDuration}} Â· Analysis: {{.AnalysisDuration}}</p>
</div>

</main><!-- /main-content -->

<!-- Right TOC -->
<nav class="toc" id="toc">
  <div class="toc-title">Navigation</div>
  <a class="toc-link" data-target="s-banner">Status</a>
  {{if .Findings}}
  <a class="toc-link" data-target="s-findings">Findings ({{len .Findings}})</a>
  {{range .Findings}}
  <a class="toc-link sub" data-target="f-{{.Check}}">{{.Check}}</a>
  {{end}}
  {{end}}
  {{if .Verdict}}<a class="toc-link" data-target="s-verdict">Verdict</a>{{end}}
  {{if .Verdict}}{{if .Verdict.Timeline}}<a class="toc-link" data-target="s-timeline">Timeline</a>{{end}}{{end}}
  {{if .SigmaMatches}}<a class="toc-link" data-target="s-sigma">Sigma ({{len .SigmaMatches}})</a>{{end}}
  {{if .IoCs}}<a class="toc-link" data-target="s-iocs">IoCs</a>{{end}}
  {{if .RawFindings}}<a class="toc-link" data-target="s-raw">Analysis Failures</a>{{end}}
  {{if .Verdict}}{{if .Verdict.DataGaps}}<a class="toc-link" data-target="s-gaps">Data Gaps</a>{{end}}{{end}}
  {{if .CollectionFailures}}<div class="toc-sep"></div><a class="toc-link" data-target="s-failures">Failures</a>{{end}}
  {{if .EvidenceHashes}}<a class="toc-link" data-target="s-integrity">Integrity</a>{{end}}
</nav>

</div><!-- /page-layout -->

<script>
(function(){

/* â”€â”€ Theme â”€â”€ */
var html = document.documentElement;
var themeBtn = document.getElementById('theme-btn');
if(localStorage.getItem('coroner-theme')==='light'){html.setAttribute('data-theme','light');if(themeBtn)themeBtn.textContent='ðŸŒ™ Dark';}
window.toggleTheme=function(){
  var light=html.getAttribute('data-theme')==='light';
  if(light){html.removeAttribute('data-theme');localStorage.setItem('coroner-theme','dark');if(themeBtn)themeBtn.textContent='â˜€ Light';}
  else{html.setAttribute('data-theme','light');localStorage.setItem('coroner-theme','light');if(themeBtn)themeBtn.textContent='ðŸŒ™ Dark';}
};

/* â”€â”€ Section toggle â”€â”€ */
window.toggleSec=function(key){
  var body=document.getElementById('body-'+key);
  var chev=document.getElementById('chev-'+key);
  var hdr=body&&body.previousElementSibling;
  if(!body)return;
  var hidden=body.classList.toggle('hidden');
  if(chev)chev.classList.toggle('closed',hidden);
  if(hdr)hdr.classList.toggle('is-open',!hidden);
};

/* â”€â”€ Finding toggle â”€â”€ */
window.toggleFinding=function(id){
  var body=document.getElementById('fbody-'+id);
  var chev=document.getElementById('chev-f-'+id);
  if(!body)return;
  var hidden=body.classList.toggle('hidden');
  if(chev)chev.classList.toggle('closed',hidden);
};

/* â”€â”€ TOC click handler â”€â”€ */
function ensureVisible(key){
  var body=document.getElementById('body-'+key);
  if(body&&body.classList.contains('hidden'))toggleSec(key);
}
document.querySelectorAll('.toc-link[data-target]').forEach(function(link){
  link.addEventListener('click',function(e){
    e.preventDefault();
    var target=link.getAttribute('data-target');
    var el=document.getElementById(target);
    if(!el)return;
    if(target.startsWith('f-')){
      ensureVisible('findings');
    } else {
      ensureVisible(target.replace('s-',''));
    }
    setTimeout(function(){el.scrollIntoView({behavior:'smooth',block:'start'});},30);
  });
});

/* â”€â”€ TOC active tracking (IntersectionObserver) â”€â”€ */
var tocLinks=document.querySelectorAll('.toc-link[data-target]');
function setActive(id){
  tocLinks.forEach(function(l){l.classList.toggle('active',l.getAttribute('data-target')===id);});
}
if('IntersectionObserver' in window){
  var obs=new IntersectionObserver(function(entries){
    var hit=null;
    entries.forEach(function(e){if(e.isIntersecting)hit=e.target.id;});
    if(hit)setActive(hit);
  },{rootMargin:'-56px 0px -65% 0px',threshold:0});
  document.querySelectorAll('[id]').forEach(function(el){
    if(el.id.startsWith('s-')||el.id.startsWith('f-'))obs.observe(el);
  });
}

/* â”€â”€ Copy section text â”€â”€ */
window.copySection=function(key,btn){
  var body=document.getElementById('body-'+key);
  if(!body)return;
  var wasHidden=body.classList.contains('hidden');
  if(wasHidden)body.classList.remove('hidden');
  var text=body.innerText;
  if(wasHidden)body.classList.add('hidden');
  navigator.clipboard.writeText(text).then(function(){
    if(btn){var orig=btn.textContent;btn.textContent='Copied!';btn.classList.add('ok');setTimeout(function(){btn.textContent=orig;btn.classList.remove('ok');},1500);}
  }).catch(function(){});
};

/* â”€â”€ Copy full report â”€â”€ */
window.copyAllReport=function(){
  var btn=document.getElementById('btn-copy-all');
  var parts=[];
  ['s-banner','s-summary','body-verdict','body-timeline','body-findings',
   'body-sigma','body-iocs','body-gaps','body-failures','body-integrity'].forEach(function(id){
    var el=document.getElementById(id);
    if(el){
      var wasHidden=el.classList.contains('hidden');
      if(wasHidden)el.classList.remove('hidden');
      parts.push(el.innerText.trim());
      if(wasHidden)el.classList.add('hidden');
    }
  });
  navigator.clipboard.writeText(parts.filter(Boolean).join('\n\n---\n\n')).then(function(){
    if(btn){btn.textContent='Copied!';btn.classList.add('ok');setTimeout(function(){btn.textContent='Copy Report';btn.classList.remove('ok');},1800);}
  }).catch(function(){});
};

/* â”€â”€ JSON highlighting â”€â”€ */
window.highlightJson=function(t){
  var s=t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  return s.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,function(m){
    var c=/^"/.test(m)?(/:$/.test(m)?'json-key':'json-str'):/true|false/.test(m)?'json-bool':/null/.test(m)?'json-null':'json-num';
    return '<span class="'+c+'">'+m+'</span>';
  });
};
window.copyJsonViewer=function(id,btn){
  var el=document.getElementById(id);
  if(!el)return;
  navigator.clipboard.writeText(el.textContent).then(function(){
    if(btn){var orig=btn.textContent;btn.textContent='Copied!';btn.classList.add('ok');setTimeout(function(){btn.textContent=orig;btn.classList.remove('ok');},1500);}
  }).catch(function(){});
};
document.querySelectorAll('.json-viewer').forEach(function(el){
  if(el.textContent.trim())el.innerHTML=highlightJson(el.textContent);
});

/* â”€â”€ IoC export â”€â”€ */
window.downloadIoCs=function(format){
  var table=document.getElementById('ioc-table');
  if(!table)return;
  var headers=Array.from(table.querySelectorAll('thead th')).map(function(th){return th.textContent.trim().toLowerCase();});
  var rows=Array.from(table.querySelectorAll('tbody tr')).map(function(tr){
    return Array.from(tr.querySelectorAll('td')).map(function(td){return td.textContent.trim();});
  });
  var content,mime,ext;
  if(format==='json'){
    var data=rows.map(function(r){var o={};headers.forEach(function(h,i){o[h]=r[i]||'';});return o;});
    content=JSON.stringify(data,null,2);mime='application/json';ext='json';
  } else {
    var lines=[headers.map(function(h){return'"'+h+'"';}).join(',')];
    rows.forEach(function(r){lines.push(r.map(function(c){return'"'+(c||'').replace(/"/g,'""')+'"';}).join(','));});
    content=lines.join('\n');mime='text/csv';ext='csv';
  }
  var blob=new Blob([content],{type:mime});
  var a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='iocs.'+ext;
  document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(a.href);
};

})();
</script>

<!-- Interactive Feedback UI (only active when server is running) -->
<div id="feedback-panel" style="display:none;position:fixed;bottom:20px;right:20px;z-index:1000;">
  <button id="feedback-btn" onclick="toggleFeedbackForm()"
          style="background:#2563eb;color:white;border:none;border-radius:50px;padding:12px 20px;
                 cursor:pointer;font-size:14px;box-shadow:0 4px 12px rgba(0,0,0,0.3);">
    &#x1F4AC; Analyst Feedback
  </button>
  <div id="feedback-form" style="display:none;background:var(--card,#161b22);border:1px solid var(--border,#30363d);
       border-radius:12px;padding:20px;width:400px;box-shadow:0 8px 24px rgba(0,0,0,0.15);">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
      <strong style="font-size:15px;color:var(--fg,#c9d1d9);">Analyst Feedback</strong>
      <button onclick="toggleFeedbackForm()" style="background:none;border:none;cursor:pointer;font-size:18px;color:var(--fg-muted,#8b949e);">&#x2715;</button>
    </div>
    <p style="font-size:12px;color:var(--fg-muted,#8b949e);margin:0 0 12px;">
      Describe what is normal in your environment. The LLM will re-evaluate the report with this context.<br>
      <em>Example: "rclone.exe is a backup tool I installed"</em>
    </p>
    <textarea id="feedback-text" rows="5"
              style="width:100%;border:1px solid var(--border,#30363d);border-radius:8px;padding:10px;
                     font-size:13px;resize:vertical;box-sizing:border-box;background:var(--bg,#0d1117);color:var(--fg,#c9d1d9);"
              placeholder="rclone.exe is my backup tool&#10;administrator account is my admin account&#10;..."></textarea>
    <div style="display:flex;gap:8px;margin-top:12px;">
      <button id="feedback-submit" onclick="submitFeedback()"
              style="flex:1;background:#2563eb;color:white;border:none;border-radius:8px;
                     padding:10px;cursor:pointer;font-size:14px;">
        Re-evaluate
      </button>
    </div>
    <div id="feedback-status" style="margin-top:8px;font-size:12px;color:var(--fg-muted,#8b949e);text-align:center;"></div>
  </div>
</div>

<script>
(function(){
  fetch('/health',{method:'GET'})
    .then(function(r){return r.ok?r.json():Promise.reject();})
    .then(function(){
      document.getElementById('feedback-panel').style.display='block';
    })
    .catch(function(){});
})();

function toggleFeedbackForm(){
  var form=document.getElementById('feedback-form');
  var btn=document.getElementById('feedback-btn');
  var isHidden=form.style.display==='none';
  form.style.display=isHidden?'block':'none';
  btn.style.display=isHidden?'none':'block';
}

function submitFeedback(){
  var text=document.getElementById('feedback-text').value.trim();
  if(!text){return;}
  var submitBtn=document.getElementById('feedback-submit');
  var status=document.getElementById('feedback-status');
  submitBtn.disabled=true;
  submitBtn.textContent='Analyzing...';

  var startTime=Date.now();
  var spinFrames=['â ‹','â ™','â ¹','â ¸','â ¼','â ´','â ¦','â §','â ‡','â '];
  var spinIdx=0;
  function updateStatus(){
    var elapsed=Math.floor((Date.now()-startTime)/1000);
    var timeStr=elapsed>=60?(Math.floor(elapsed/60)+'m '+(elapsed%60)+'s'):(elapsed+'s');
    status.textContent=spinFrames[spinIdx%spinFrames.length]+' Re-evaluating with LLM... '+timeStr+' elapsed';
    spinIdx++;
  }
  updateStatus();
  var timer=setInterval(updateStatus,200);

  fetch('/re-evaluate',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({context:text})
  })
  .then(function(r){
    if(!r.ok)throw new Error('Server error: '+r.status);
    return r.text();
  })
  .then(function(html){
    clearInterval(timer);
    document.open();
    document.write(html);
    document.close();
  })
  .catch(function(err){
    clearInterval(timer);
    status.textContent='âš  Error: '+err.message;
    submitBtn.disabled=false;
    submitBtn.textContent='Re-evaluate';
  });
}
</script>
</body>
</html>
