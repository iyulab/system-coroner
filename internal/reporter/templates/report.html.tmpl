<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>system-coroner Report ‚Äî {{.Hostname}}</title>
<style>
:root {
  --bg: #0d1117; --fg: #c9d1d9; --card: #161b22; --border: #30363d;
  --red: #dc2626; --yellow: #d97706; --green: #3fb950; --blue: #58a6ff;
  --red-bg: #3d1418; --yellow-bg: #3d2200; --green-bg: #0d3117;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif; background: var(--bg); color: var(--fg); line-height: 1.6; }
.container { max-width: 1200px; margin: 0 auto; padding: 20px; }

/* Banner */
.banner { padding: 36px 24px; border-radius: 8px; margin-bottom: 24px; text-align: center; }
.banner-critical { background: #450a0a; border: 3px solid var(--red); animation: pulse-border 2s ease-in-out infinite; }
.banner-critical h1 { color: var(--red); }
.banner-red { background: var(--red-bg); border: 2px solid var(--red); }
.banner-red h1 { color: var(--red); }
.banner-yellow { background: var(--yellow-bg); border: 2px solid var(--yellow); }
.banner-yellow h1 { color: var(--yellow); }
.banner-green { background: var(--green-bg); border: 2px solid var(--green); }
.banner-green h1 { color: var(--green); }
.banner h1 { font-size: 2.2em; margin-bottom: 8px; font-weight: 800; letter-spacing: 0.04em; }
.banner p { font-size: 1.1em; opacity: 0.9; }
@keyframes pulse-border {
  0%, 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.5); }
  50% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); }
}

/* Summary */
.summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
.stat-card { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 16px; text-align: center; }
.stat-card .value { font-size: 2em; font-weight: bold; }
.stat-card .label { font-size: 0.85em; opacity: 0.7; margin-top: 4px; }

/* Cards */
.card { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 20px; margin-bottom: 16px; }
.card h2 { font-size: 1.3em; margin-bottom: 12px; color: var(--blue); }
.card h3 { font-size: 1.1em; margin-bottom: 8px; }

/* Badges */
.badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 0.75em; font-weight: bold; text-transform: uppercase; }
.confidence-confirmed { background: #dc2626; color: #fff; }
.confidence-high { background: #d97706; color: #fff; }
.confidence-medium { background: #ca8a04; color: #fff; }
.confidence-low { background: #388bfd; color: #fff; }
.confidence-info { background: var(--border); color: var(--fg); }
.risk-critical { background: #dc2626; color: #fff; }
.risk-high { background: #d97706; color: #fff; }
.risk-medium { background: #ca8a04; color: #fff; }
.risk-low { background: var(--border); color: var(--fg); }

/* Evidence */
.evidence-list { list-style: none; padding: 0; }
.evidence-list li { padding: 6px 0; border-bottom: 1px solid var(--border); font-family: monospace; font-size: 0.9em; }
.evidence-list li:last-child { border-bottom: none; }

/* MITRE tags */
.mitre-tag { display: inline-block; background: #1f2937; border: 1px solid var(--blue); color: var(--blue); padding: 2px 6px; border-radius: 4px; font-size: 0.8em; margin: 2px; }

/* Actions */
.action-list { list-style: decimal; padding-left: 20px; }
.action-list li { padding: 4px 0; }

/* IoC table */
table { width: 100%; border-collapse: collapse; margin-top: 8px; }
th, td { padding: 8px 12px; text-align: left; border-bottom: 1px solid var(--border); }
th { background: rgba(255,255,255,0.05); font-weight: 600; }
td { font-family: monospace; font-size: 0.9em; }

/* Collapsible */
details { margin-top: 8px; }
details summary { cursor: pointer; color: var(--blue); font-size: 0.9em; }
details summary:hover { text-decoration: underline; }

/* Reasoning chain */
.reasoning { background: rgba(255,255,255,0.03); border-radius: 4px; padding: 12px; margin-top: 8px; font-size: 0.9em; }
.reasoning dt { font-weight: bold; color: var(--blue); margin-top: 8px; }
.reasoning dt:first-child { margin-top: 0; }
.reasoning dd { margin-left: 16px; }

/* Timeline */
.timeline-item { display: flex; gap: 12px; padding: 8px 0; border-left: 2px solid var(--border); padding-left: 16px; margin-left: 8px; }
.timeline-time { font-family: monospace; font-size: 0.85em; min-width: 180px; color: var(--blue); }
.timeline-event { flex: 1; }

/* Kill Chain phase badges (UI-004) */
.kc-initial   { background: #1d4ed8; color: #fff; padding: 2px 7px; border-radius: 4px; font-size: 0.78em; white-space: nowrap; }
.kc-execution { background: #b45309; color: #fff; padding: 2px 7px; border-radius: 4px; font-size: 0.78em; white-space: nowrap; }
.kc-evasion   { background: #065f46; color: #fff; padding: 2px 7px; border-radius: 4px; font-size: 0.78em; white-space: nowrap; }
.kc-lateral   { background: #7c3aed; color: #fff; padding: 2px 7px; border-radius: 4px; font-size: 0.78em; white-space: nowrap; }
.kc-impact    { background: #dc2626; color: #fff; padding: 2px 7px; border-radius: 4px; font-size: 0.78em; white-space: nowrap; }
.kc-default   { background: var(--border); color: var(--fg); padding: 2px 7px; border-radius: 4px; font-size: 0.78em; white-space: nowrap; }

/* Collection failure kind badges (ARCH-004) */
.fk-timeout    { background: #b45309; color: #fff; }
.fk-permission { background: #dc2626; color: #fff; }
.fk-script     { background: #ca8a04; color: #fff; }
.fk-notfound   { background: #6b7280; color: #fff; }
.fk-unknown    { background: var(--border); color: var(--fg); }

/* Sigma rule level badges (SIG-001) */
.sigma-critical { background: #7f1d1d; color: #fca5a5; border: 1px solid #dc2626; }
.sigma-high     { background: #7c2d12; color: #fdba74; border: 1px solid #ea580c; }
.sigma-medium   { background: #713f12; color: #fde68a; border: 1px solid #d97706; }
.sigma-low      { background: #1e3a5f; color: #93c5fd; border: 1px solid #3b82f6; }
.sigma-info     { background: var(--card); color: var(--fg-muted); border: 1px solid var(--border); }
.sigma-card { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 14px 16px; margin-bottom: 10px; }
.sigma-card-header { display: flex; align-items: center; gap: 10px; margin-bottom: 6px; }
.sigma-event { font-family: monospace; font-size: 0.8em; color: var(--fg-muted); margin-top: 8px; white-space: pre-wrap; word-break: break-all; }

/* Raw JSON viewer (UI-007) */
.json-viewer { background: rgba(0,0,0,0.3); border-radius: 4px; padding: 12px; font-family: monospace; font-size: 0.82em; overflow-x: auto; white-space: pre; max-height: 400px; overflow-y: auto; margin-top: 8px; }
.json-key  { color: #60a5fa; }
.json-str  { color: #34d399; }
.json-num  { color: #fb923c; }
.json-bool { color: #a78bfa; }
.json-null { color: #9ca3af; }

/* Export button (UI-006) */
.btn { display: inline-block; padding: 5px 12px; border-radius: 6px; font-size: 0.82em; cursor: pointer; border: 1px solid var(--border); background: var(--card); color: var(--fg); margin-left: 8px; }
.btn:hover { background: rgba(255,255,255,0.08); border-color: var(--blue); color: var(--blue); }

/* Light theme overrides (UI-001) */
[data-theme="light"] {
  --bg: #ffffff; --fg: #1f2328; --card: #f6f8fa; --border: #d0d7de;
  --blue: #0969da;
  --red-bg: #fff0ee; --yellow-bg: #fff8e5; --green-bg: #f0fff4;
}
[data-theme="light"] body { background: var(--bg); color: var(--fg); }
[data-theme="light"] .reasoning { background: rgba(0,0,0,0.04); }
[data-theme="light"] pre { background: rgba(0,0,0,0.05) !important; }

/* Theme toggle button */
.theme-toggle { position: fixed; top: 14px; right: 14px; z-index: 100; padding: 6px 12px; border-radius: 20px; border: 1px solid var(--border); background: var(--card); color: var(--fg); cursor: pointer; font-size: 0.82em; box-shadow: 0 1px 4px rgba(0,0,0,0.3); }
.theme-toggle:hover { border-color: var(--blue); color: var(--blue); }

/* Footer */
.footer { text-align: center; padding: 24px; opacity: 0.5; font-size: 0.85em; }
</style>
</head>
<body>
<button class="theme-toggle" onclick="toggleTheme()" id="theme-btn">‚òÄ Light</button>
<div class="container">

<!-- Isolation Banner -->
<div class="banner {{bannerClass .Isolation}}">
  {{if .Isolation.Isolate}}
  <h1>{{if eq .Isolation.Urgency "immediate"}}ISOLATE IMMEDIATELY{{else}}ISOLATION RECOMMENDED{{end}}</h1>
  {{else if eq .Isolation.Banner "yellow"}}
  <h1>INVESTIGATION NEEDED</h1>
  {{else}}
  <h1>NO INTRUSION DETECTED</h1>
  {{end}}
  <p>{{.Isolation.Reason}}</p>
</div>

<!-- Summary Stats -->
<div class="summary">
  <div class="stat-card">
    <div class="value">{{.Hostname}}</div>
    <div class="label">Server</div>
  </div>
  <div class="stat-card">
    <div class="value">{{.TotalChecks}}</div>
    <div class="label">Checks Executed</div>
  </div>
  <div class="stat-card">
    <div class="value" style="color: #dc2626;">{{.ConfidenceSummary.Confirmed}}</div>
    <div class="label">Confirmed</div>
  </div>
  <div class="stat-card">
    <div class="value" style="color: #d97706;">{{.ConfidenceSummary.High}}</div>
    <div class="label">High</div>
  </div>
  <div class="stat-card">
    <div class="value" style="color: #ca8a04;">{{.ConfidenceSummary.Medium}}</div>
    <div class="label">Medium</div>
  </div>
  <div class="stat-card">
    <div class="value" style="color: var(--blue);">{{.ConfidenceSummary.Low}}</div>
    <div class="label">Low</div>
  </div>
  <div class="stat-card">
    <div class="value" style="color: var(--green);">{{.ConfidenceSummary.Clean}}</div>
    <div class="label">Clean</div>
  </div>
</div>

<!-- Verdict (if available) -->
{{if .Verdict}}
<div class="card">
  <h2>Overall Verdict</h2>
  <p><strong>Status:</strong> {{.Verdict.OverallVerdict.Status}}</p>
  <p><strong>Confidence:</strong> {{.Verdict.OverallVerdict.Confidence}}</p>
  <p><strong>Recommendation:</strong> {{.Verdict.OverallVerdict.Recommendation}}</p>
  <p>{{.Verdict.OverallVerdict.Summary}}</p>
</div>
{{end}}

<!-- Timeline -->
{{if .Verdict}}{{if .Verdict.Timeline}}
<div class="card">
  <h2>Attack Timeline</h2>
  {{range .Verdict.Timeline}}
  <div class="timeline-item">
    <div class="timeline-time">{{.Timestamp}}</div>
    <div class="timeline-event">
      {{.Event}}
      <span class="{{killChainClass .KillChainPhase}}">{{.KillChainPhase}}</span>
    </div>
  </div>
  {{end}}
</div>
{{end}}{{end}}

<!-- Findings -->
{{range .Findings}}
<div class="card">
  <h2>
    <span class="badge {{confidenceClass .IntrusionConfidence}}">{{.IntrusionConfidence}}</span>
    <span class="badge {{riskClass .RiskLevel}}">{{.RiskLevel}}</span>
    {{.Title}}
  </h2>
  <p><strong>Check:</strong> {{.Check}}</p>
  <p><strong>Attack Scenario:</strong> {{.AttackScenario}}</p>

  {{if .MITRE}}
  <p><strong>MITRE ATT&CK:</strong>
    {{range .MITRE}}<span class="mitre-tag">{{.}}</span>{{end}}
  </p>
  {{end}}

  {{if .Evidence}}
  <h3>Evidence</h3>
  <ul class="evidence-list">
    {{range .Evidence}}<li>{{.}}</li>{{end}}
  </ul>
  {{end}}

  {{if .ImmediateActions}}
  <h3>Immediate Actions</h3>
  <ol class="action-list">
    {{range .ImmediateActions}}<li>{{.}}</li>{{end}}
  </ol>
  {{end}}

  {{if .ForensicNextSteps}}
  <details>
    <summary>Forensic Next Steps</summary>
    <ol class="action-list">
      {{range .ForensicNextSteps}}<li>{{.}}</li>{{end}}
    </ol>
  </details>
  {{end}}

  <details>
    <summary>Reasoning Chain</summary>
    <dl class="reasoning">
      <dt>Observation</dt><dd>{{.ReasoningChain.Observation}}</dd>
      <dt>Baseline</dt><dd>{{.ReasoningChain.Baseline}}</dd>
      <dt>Deviation</dt><dd>{{.ReasoningChain.Deviation}}</dd>
      <dt>Context</dt><dd>{{.ReasoningChain.Context}}</dd>
      <dt>Conclusion</dt><dd>{{.ReasoningChain.Conclusion}}</dd>
    </dl>
  </details>

  {{$rawJSON := index $.RawCheckData .Check}}
  {{if $rawJSON}}
  <details>
    <summary>Raw Evidence <button class="btn" onclick="copyJsonViewer('rv-{{.Check}}');event.stopPropagation()">Copy</button></summary>
    <pre class="json-viewer" id="rv-{{.Check}}">{{$rawJSON}}</pre>
  </details>
  {{end}}
</div>
{{end}}

<!-- Raw Findings (parse failures) -->
{{if .RawFindings}}
<div class="card">
  <h2>Analysis Failures</h2>
  <p>The following checks could not be parsed. Raw output is preserved for manual review.</p>
  {{range .RawFindings}}
  <details>
    <summary>{{.CheckID}} ‚Äî {{.ParseError}}</summary>
    <pre style="overflow-x:auto; padding:12px; background:rgba(0,0,0,0.3); border-radius:4px; font-size:0.85em;">{{.RawOutput}}</pre>
  </details>
  {{end}}
</div>
{{end}}

<!-- IoC Table -->
{{if .IoCs}}
<div class="card">
  <h2>Indicators of Compromise (IoC)
    <button class="btn" onclick="downloadIoCs('csv')">Export CSV</button>
    <button class="btn" onclick="downloadIoCs('json')">Export JSON</button>
  </h2>
  <table id="ioc-table">
    <thead>
      <tr><th>Type</th><th>Value</th><th>Source</th></tr>
    </thead>
    <tbody>
      {{range .IoCs}}
      <tr><td>{{.Type}}</td><td>{{.Value}}</td><td>{{.Context}}</td></tr>
      {{end}}
    </tbody>
  </table>
</div>
{{end}}

<!-- Data Gaps -->
{{if .Verdict}}{{if .Verdict.DataGaps}}
<div class="card">
  <h2>Data Gaps</h2>
  <ul>
    {{range .Verdict.DataGaps}}<li>{{.}}</li>{{end}}
  </ul>
</div>
{{end}}{{end}}

<!-- Sigma Rule Matches (SIG-001) -->
{{if .SigmaMatches}}
<div class="card">
  <h2>Sigma Rule Matches <span class="badge sigma-high" style="font-size:0.7em; vertical-align:middle;">{{len .SigmaMatches}} hit{{if gt (len .SigmaMatches) 1}}s{{end}}</span></h2>
  <p style="margin-bottom:14px; opacity:0.8;">Sigma ÌÉêÏßÄ Í∑úÏπôÏóê Îß§Ïπ≠Îêú Ìï≠Î™©ÏûÖÎãàÎã§. LLM Î∂ÑÏÑùÍ≥º ÎèÖÎ¶ΩÏ†ÅÏù∏ Í≤∞Ï†ïÎ°†Ï†Å ÌÉêÏßÄ Í≤∞Í≥ºÏûÖÎãàÎã§.</p>
  {{range .SigmaMatches}}
  <div class="sigma-card">
    <div class="sigma-card-header">
      <span class="badge {{sigmaLevelClass .Level}}">{{.Level}}</span>
      <strong>{{.RuleTitle}}</strong>
      <span style="font-family:monospace;font-size:0.82em;color:var(--fg-muted);">check: {{.CheckID}}</span>
      {{if .RuleID}}<span style="font-family:monospace;font-size:0.78em;color:var(--fg-muted);">id: {{.RuleID}}</span>{{end}}
    </div>
    {{if .Event}}
    <details>
      <summary style="cursor:pointer;font-size:0.85em;color:var(--fg-muted);">Matched Event</summary>
      <pre class="sigma-event">{{range $k,$v := .Event}}{{$k}}: {{$v}}
{{end}}</pre>
    </details>
    {{end}}
  </div>
  {{end}}
</div>
{{end}}

<!-- Collection Failures (UI-011) -->
{{if .CollectionFailures}}
<div class="card">
  <h2>Collection Failures</h2>
  <p style="margin-bottom:12px; opacity:0.8;">Îã§Ïùå Ìï≠Î™©ÏùÄ Ïä§ÌÅ¨Î¶ΩÌä∏ Ïã§ÌñâÏóê Ïã§Ìå®ÌïòÏó¨ ÏàòÏßëÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. Ìï¥Îãπ ÏòÅÏó≠Ïùò Î∂ÑÏÑù Ï†ïÌôïÎèÑÍ∞Ä ÎÇÆÏùÑ Ïàò ÏûàÏäµÎãàÎã§.</p>
  <table>
    <thead>
      <tr><th>Check</th><th>ID</th><th>Kind</th><th>Error</th></tr>
    </thead>
    <tbody>
      {{range .CollectionFailures}}
      <tr>
        <td>{{if .CheckName}}{{.CheckName}}{{else}}{{.CheckID}}{{end}}</td>
        <td style="font-family:monospace;font-size:0.85em;">{{.CheckID}}</td>
        <td><span class="badge {{failureKindClass .FailureKind}}">{{.FailureKind}}</span></td>
        <td style="font-family:monospace;font-size:0.85em;color:var(--red);">{{.Error}}</td>
      </tr>
      {{end}}
    </tbody>
  </table>
</div>
{{end}}

<!-- Evidence Integrity -->
{{if .EvidenceHashes}}
<div class="card">
  <h2>Evidence Integrity (SHA-256)</h2>
  <table>
    <thead>
      <tr><th>File</th><th>SHA-256</th><th>Size</th></tr>
    </thead>
    <tbody>
      {{range .EvidenceHashes}}
      <tr><td>{{.File}}</td><td style="font-size:0.8em;">{{.SHA256}}</td><td>{{.Size}} B</td></tr>
      {{end}}
    </tbody>
  </table>
</div>
{{end}}

<!-- Footer -->
<div class="footer">
  <p>Generated by system-coroner {{.Version}} | {{.GeneratedAt.Format "2006-01-02 15:04:05 UTC"}} | {{.OS}}</p>
  <p>Collection: {{.CollectionDuration}} | Analysis: {{.AnalysisDuration}}</p>
</div>

</div>

<script>
(function() {
  // Theme toggle (UI-001)
  var html = document.documentElement;
  var btn = document.getElementById('theme-btn');
  var saved = localStorage.getItem('coroner-theme');
  if (saved === 'light') { html.setAttribute('data-theme', 'light'); if (btn) btn.textContent = 'üåô Dark'; }
  window.toggleTheme = function() {
    var isLight = html.getAttribute('data-theme') === 'light';
    if (isLight) { html.removeAttribute('data-theme'); localStorage.setItem('coroner-theme', 'dark'); if (btn) btn.textContent = '‚òÄ Light'; }
    else { html.setAttribute('data-theme', 'light'); localStorage.setItem('coroner-theme', 'light'); if (btn) btn.textContent = 'üåô Dark'; }
  };

  // JSON syntax highlighter (UI-007)
  window.highlightJson = function(text) {
    var s = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    return s.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function(m) {
      var c = /^"/.test(m) ? (/:$/.test(m) ? 'json-key' : 'json-str') : /true|false/.test(m) ? 'json-bool' : /null/.test(m) ? 'json-null' : 'json-num';
      return '<span class="' + c + '">' + m + '</span>';
    });
  };
  window.copyJsonViewer = function(id) {
    var el = document.getElementById(id);
    if (!el) return;
    navigator.clipboard.writeText(el.textContent).catch(function() {});
  };
  document.querySelectorAll('.json-viewer').forEach(function(el) {
    if (el.textContent.trim()) el.innerHTML = highlightJson(el.textContent);
  });

  window.downloadIoCs = function(format) {
    var table = document.getElementById('ioc-table');
    if (!table) return;
    var headers = Array.from(table.querySelectorAll('thead th')).map(function(th) { return th.textContent.trim().toLowerCase(); });
    var rows = Array.from(table.querySelectorAll('tbody tr')).map(function(tr) {
      return Array.from(tr.querySelectorAll('td')).map(function(td) { return td.textContent.trim(); });
    });
    var content, mime, ext;
    if (format === 'json') {
      var data = rows.map(function(r) {
        var obj = {};
        headers.forEach(function(h, i) { obj[h] = r[i] || ''; });
        return obj;
      });
      content = JSON.stringify(data, null, 2);
      mime = 'application/json';
      ext = 'json';
    } else {
      var lines = [headers.map(function(h) { return '"' + h + '"'; }).join(',')];
      rows.forEach(function(r) {
        lines.push(r.map(function(c) { return '"' + (c || '').replace(/"/g, '""') + '"'; }).join(','));
      });
      content = lines.join('\n');
      mime = 'text/csv';
      ext = 'csv';
    }
    var blob = new Blob([content], {type: mime});
    var a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'iocs.' + ext;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(a.href);
  };
})();
</script>
</body>
</html>
